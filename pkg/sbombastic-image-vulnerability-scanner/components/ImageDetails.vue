<template>
  <div class="page">
    <!-- Header Section -->
    <div class="header-section">
      <div class="title">
        Image: {{ imageName }}
        <BadgeState 
          :color="getSeverityColor(overallSeverity)" 
          :label="t(`imageScanner.enum.cve.${overallSeverity}`)"
          class="severity-badge"
        />
      </div>
      <div class="header-actions">
                <button
          class="btn role-primary"
          aria-label="Download full report"
          type="button"
          @click="downloadFullReport">
          <i class="icon icon-download"></i>
          {{ t('imageScanner.images.downloadReport') }}
        </button>
      </div>
    </div>

    <!-- Image Information Section -->
    <div class="image-info-section">
      <div class="info-grid">
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.status') }}:</span>
          <span class="value">{{ imageDetails.status }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.vulnerabilities') }}:</span>
          <span class="value">{{ totalVulnerabilities.toLocaleString() }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.repository') }}:</span>
          <span class="value">{{ imageDetails.repository }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.registry') }}:</span>
          <span class="value">{{ imageDetails.registry }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.architecture') }}:</span>
          <span class="value">{{ imageDetails.architecture }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.operatingSystem') }}:</span>
          <span class="value">{{ imageDetails.operatingSystem }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.size') }}:</span>
          <span class="value">{{ imageDetails.size }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.author') }}:</span>
          <span class="value">{{ imageDetails.author }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.dockerVersion') }}:</span>
          <span class="value">{{ imageDetails.dockerVersion }}</span>
        </div>
        <div class="info-item">
          <span class="label">{{ t('imageScanner.imageDetails.created') }}:</span>
          <span class="value">{{ imageDetails.created }}</span>
        </div>
        <div class="info-item show-properties-link">
          <a href="#" @click.prevent="showAllProperties = !showAllProperties">
            {{ showAllProperties ? t('imageScanner.imageDetails.showLessProperties') : t('imageScanner.imageDetails.showAllProperties') }}
          </a>
        </div>
        <div class="info-item" v-if="showAllProperties">
          <span class="label">{{ t('imageScanner.imageDetails.imageId') }}:</span>
          <span class="value">{{ imageDetails.imageId || 'sha256:abc123...' }}</span>
        </div>
        <div class="info-item" v-if="showAllProperties">
          <span class="label">{{ t('imageScanner.imageDetails.layers') }}:</span>
          <span class="value">{{ imageDetails.layers || '12' }}</span>
        </div>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-section">
      <!-- Most Severe Vulnerabilities Section -->
      <div class="vulnerabilities-section">
        <div class="title">
          {{ t('imageScanner.imageDetails.mostSevereVulnerabilities') }}
          <i class="icon icon-question-mark"></i>
        </div>
        <div class="vulnerabilities-list">
          <div 
            v-for="vuln in mostSevereVulnerabilities" 
            :key="vuln.cveId"
            class="row"
          >
            <div class="col span-4">
              <RouterLink>
                {{ vuln.cveId }}
              </RouterLink>
            </div>
            <div class="col span-3">
              <ScoreBadge 
                :score="parseFloat(vuln.score.split(' ')[0])" 
                :scoreType="vuln.score.split(' ')[1].replace(/[()]/g, '')"
              />
            </div>
            <div class="col span-4">{{ vuln.package }}</div>
            <div class="col span-1">
              <i 
                :class="vuln.fixAvailable ? 'icon icon-confirmation-alt' : 'icon icon-notify-error'" 
                :style="{ 
                  color: vuln.fixAvailable ? '#007cba' : '#E2E3EB',
                  fontSize: '1.5rem'
                }"
              ></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Severity Distribution Section -->
      <div class="severity-section">
        <div class="title">
          {{ t('imageScanner.imageDetails.severityDistribution') }}
          <i class="icon icon-question-mark"></i>
        </div>
        <BarChart 
          :chartData="severityDistribution" 
          :description="t('imageScanner.imageDetails.vulnerabilitiesInTotal')"
          colorPrefix="cve"
        />
      </div>
    </div>

    <!-- Search Filters - Disabled for MVP version -->
    <!-- <div class="search-filters">
      <div class="filter-row">
        <div class="filter-item">
          <label>CVE</label>
          <div class="filter-input-wrapper">
            <input 
              v-model="filters.cveSearch" 
              type="text" 
              placeholder="Search by ID"
              class="filter-input"
            />
            <i class="icon icon-search" style="color: #6C6C76; margin-left: 8px;"></i>
          </div>
        </div>
        <div class="filter-item">
          <label>{{ t('imageScanner.imageDetails.score') }}</label>
          <div class="filter-input-wrapper">
            <input 
              v-model="filters.score" 
              type="text" 
              placeholder="0 - 9.9"
              class="filter-input score-input"
            />
            <i class="icon icon-filter" style="color: #6C6C76; margin-left: 8px;"></i>
          </div>
        </div>
        <div class="filter-item">
          <label>{{ t('imageScanner.imageDetails.searchByName') }}</label>
          <div class="filter-input-wrapper">
            <input 
              v-model="filters.packageSearch" 
              type="text" 
              :placeholder="t('imageScanner.imageDetails.searchByNamePlaceholder')"
              class="filter-input"
            />
            <i class="icon icon-search" style="color: #6C6C76; margin-left: 8px;"></i>
          </div>
        </div>
        <div class="filter-item">
          <label>{{ t('imageScanner.imageDetails.fixAvailable') }}</label>
          <select v-model="filters.fixAvailable" class="filter-select">
            <option value="any">{{ t('imageScanner.imageDetails.any') }}</option>
            <option value="available">{{ t('imageScanner.imageDetails.available') }}</option>
            <option value="not-available">{{ t('imageScanner.imageDetails.notAvailable') }}</option>
          </select>
        </div>
        <div class="filter-item">
          <label>{{ t('imageScanner.imageDetails.severity') }}</label>
          <select v-model="filters.severity" class="filter-select">
            <option value="any">{{ t('imageScanner.imageDetails.any') }}</option>
            <option value="critical">{{ t('imageScanner.enum.cve.critical') }}</option>
            <option value="high">{{ t('imageScanner.enum.cve.high') }}</option>
            <option value="medium">{{ t('imageScanner.enum.cve.medium') }}</option>
            <option value="low">{{ t('imageScanner.enum.cve.low') }}</option>
            <option value="none">{{ t('imageScanner.enum.cve.none') }}</option>
          </select>
        </div>
        <div class="filter-item">
          <label>{{ t('imageScanner.imageDetails.exploitability') }}</label>
          <select v-model="filters.exploitability" class="filter-select">
            <option value="any">{{ t('imageScanner.imageDetails.any') }}</option>
            <option value="affected">{{ t('imageScanner.imageDetails.affected') }}</option>
            <option value="not-affected">{{ t('imageScanner.imageDetails.not-affected') }}</option>
            <option value="investigating">{{ t('imageScanner.imageDetails.investigating') }}</option>
            <option value="fixed">{{ t('imageScanner.imageDetails.fixed') }}</option>
            <option value="no-vex-data">{{ t('imageScanner.imageDetails.noVexData') }}</option>
          </select>
        </div>
      </div>
    </div> -->

    <!-- Vulnerability Table -->
    <SortableTable
      :rows="filteredVulnerabilities"
      :headers="VULNERABILITY_DETAILS_TABLE"
      :has-advanced-filtering="false"
      :namespaced="false"
      :row-actions="false"
      :search="true"
      @selection="onSelectionChange"
    >
      <template #header-left>
        <div class="table-header-actions">
          <button
            class="btn role-primary"
            :disabled="!selectedVulnerabilities.length"
            @click="downloadCustomReport">
            <i class="icon icon-download"></i>
            {{ t('imageScanner.images.buttons.downloadCustomReport') }}
          </button>
          <span v-if="selectedVulnerabilities.length > 0" class="selected-count">
            {{ selectedVulnerabilities.length }} {{ t('imageScanner.imageDetails.selected') }}
          </span>
        </div>
      </template>
      <template #search>
        <!-- Disable search -->
      </template>
    </SortableTable>
  </div>
</template>

<script>
import SortableTable from "@shell/components/SortableTable";
import { BadgeState } from '@components/BadgeState';
import Checkbox from '@components/Form/Checkbox';
import ScoreBadge from '@pkg/components/common/ScoreBadge';
import BarChart from '@pkg/components/common/BarChart';
import { VULNERABILITY_DETAILS_TABLE } from "@pkg/config/table-headers";
import { images } from "@pkg/data/sbombastic.rancher.io.image";

export default {
  name: 'ImageDetails',
  components: {
    SortableTable,
    BadgeState,
    Checkbox,
    ScoreBadge,
    BarChart,
  },
  data() {
    return {
      imageName: '',
      imageDetails: {},
      mostSevereVulnerabilities: [],
      severityDistribution: {},
      vulnerabilityDetails: [],
      selectedVulnerabilities: [],
      showAllProperties: false,
      filters: {
        cveSearch: '',
        score: '',
        packageSearch: '',
        fixAvailable: 'any',
        severity: 'any',
        exploitability: 'any',
        groupByLayer: false,
      },
      VULNERABILITY_DETAILS_TABLE,
    }
  },

  async fetch() {
    // Get image name from route params
    this.imageName = this.$route.params.id || 'imagemagick4.8.5613';
    
    // Find the image from the existing data
    const image = images.find(img => img.metadata.name === this.imageName);
    if (image) {
      this.imageDetails = {
        status: 'Affected',
        repository: image.spec.repository,
        registry: image.spec.registry,
        architecture: 'amd64',
        operatingSystem: 'Linux',
        size: '584.12 Mb',
        author: 'n/a',
        dockerVersion: '1.13.0',
        created: 'Oct 19, 2024 4:37 AM'
      };
      this.severityDistribution = image.spec.scanResult;
    }
    
    // Load mock vulnerability details
    this.vulnerabilityDetails = this.getMockVulnerabilityDetails();
    
    // Calculate derived data
    this.calculateMostSevereVulnerabilities();
  },

  computed: {
    totalVulnerabilities() {
      return Object.values(this.severityDistribution).reduce((sum, count) => sum + count, 0);
    },

    overallSeverity() {
      const severities = ['critical', 'high', 'medium', 'low', 'none'];
      for (const severity of severities) {
        if (this.severityDistribution[severity] > 0) {
          return severity;
        }
      }
      return 'none';
    },

    severityDistributionWithPercentages() {
      const total = this.totalVulnerabilities;
      const distribution = {};
      
      Object.keys(this.severityDistribution).forEach(severity => {
        const count = this.severityDistribution[severity];
        distribution[severity] = {
          count,
          percentage: total > 0 ? ((count / total) * 100).toFixed(1) : 0
        };
      });
      
      return distribution;
    },

    filteredVulnerabilities() {
      let filtered = [...this.vulnerabilityDetails];

      if (this.filters.cveSearch) {
        filtered = filtered.filter(v => 
          v.cveId.toLowerCase().includes(this.filters.cveSearch.toLowerCase())
        );
      }

      if (this.filters.score) {
        const score = parseFloat(this.filters.score);
        filtered = filtered.filter(v => {
          const vulnScore = parseFloat(v.score.split(' ')[0]);
          return vulnScore >= score;
        });
      }

      if (this.filters.packageSearch) {
        filtered = filtered.filter(v => 
          v.package.toLowerCase().includes(this.filters.packageSearch.toLowerCase())
        );
      }

      if (this.filters.fixAvailable !== 'any') {
        const hasFix = this.filters.fixAvailable === 'available';
        filtered = filtered.filter(v => v.fixAvailable === hasFix);
      }

      if (this.filters.severity !== 'any') {
        filtered = filtered.filter(v => v.severity === this.filters.severity);
      }

      if (this.filters.exploitability !== 'any') {
        filtered = filtered.filter(v => v.exploitability === this.filters.exploitability);
      }

      return filtered;
    },
  },

  methods: {
    getSeverityColor(severity) {
      const colors = {
        critical: 'critical-severity',
        high: 'bg-error',
        medium: 'bg-warning',
        low: 'bg-warning',
        none: 'bg-info'
      };
      return colors[severity] || colors.none;
    },

    getSeverityBarColor(severity) {
      const colors = {
        critical: '#850917',
        high: '#DE2136',
        medium: '#FF8533',
        low: '#FDD835',
        none: '#E0E0E0'
      };
      return colors[severity] || colors.none;
    },

    getMockVulnerabilityDetails() {
      return [
        {
          cveId: 'CVE-2017-5337',
          score: '9.9 (v3)',
          package: 'tomcat-embed-jasper-9.1',
          fixAvailable: true,
          fixVersion: '7.28.1.3',
          severity: 'critical',
          exploitability: 'affected',
          packageVersion: '7.26.0.1+weezy20',
          packagePath: '/usr/local/bin/'
        },
        {
          cveId: 'CVE-2018-1000007',
          score: '9.6 (v3)',
          package: 'libxml2',
          fixAvailable: false,
          fixVersion: null,
          severity: 'critical',
          exploitability: 'not-affected',
          packageVersion: '2.8.0+dfsg+17+weezy9',
          packagePath: '/usr/local/bin/'
        },
        {
          cveId: 'CVE-2019-10989',
          score: '8.8 (v2)',
          package: 'python2.7',
          fixAvailable: false,
          fixVersion: null,
          severity: 'critical',
          exploitability: 'investigating',
          packageVersion: '2.7.3.6+deb7u3',
          packagePath: '/'
        },
        {
          cveId: 'CVE-2020-0601',
          score: '8.8 (v3)',
          package: 'tomcat-api-el-9.0',
          fixAvailable: true,
          fixVersion: '10.1.39+deb',
          severity: 'critical',
          exploitability: 'investigating',
          packageVersion: '10.1.34.11.0.2.9.0.28',
          packagePath: '/'
        },
        {
          cveId: 'CVE-2021-22918',
          score: '8.8 (v3)',
          package: 'imagemagick',
          fixAvailable: false,
          fixVersion: null,
          severity: 'critical',
          exploitability: 'no-vex-data',
          packageVersion: '4.8.5613+deb7u9',
          packagePath: '/usr/bin/'
        },
        {
          cveId: 'CVE-2016-7925',
          score: '9.3 (v3)',
          package: 'tomcat-api-el-9.0',
          fixAvailable: true,
          fixVersion: '8.21.6',
          severity: 'high',
          exploitability: 'affected',
          packageVersion: '7.26.0.1+weezy20',
          packagePath: '/home/klipper-helm/.l...'
        },
        {
          cveId: 'CVE-2015-1635',
          score: '7.8 (v3)',
          package: 'imagemagick',
          fixAvailable: false,
          fixVersion: null,
          severity: 'medium',
          exploitability: 'fixed',
          packageVersion: '4.8.5613+deb7u9',
          packagePath: '/usr/bin/'
        },
        {
          cveId: 'CVE-2020-14386',
          score: '5.5 (v3)',
          package: 'python2.7',
          fixAvailable: false,
          fixVersion: null,
          severity: 'low',
          exploitability: 'not-affected',
          packageVersion: '2.7.3.6+deb7u3',
          packagePath: '/'
        },
        {
          cveId: 'CVE-2021-22986',
          score: '',
          package: 'tomcat-embed-jasper-9.1',
          fixAvailable: true,
          fixVersion: '10.1',
          severity: 'none',
          exploitability: 'fixed',
          packageVersion: '7.26.0.1+weezy20',
          packagePath: '/usr/bin/'
        }
      ];
    },

    calculateMostSevereVulnerabilities() {
      const sorted = [...this.vulnerabilityDetails]
        .sort((a, b) => {
          const scoreA = parseFloat(a.score.split(' ')[0]) || 0;
          const scoreB = parseFloat(b.score.split(' ')[0]) || 0;
          return scoreB - scoreA;
        })
        .slice(0, 5);
      
      this.mostSevereVulnerabilities = sorted;
    },

    onSelectionChange(selected) {
      this.selectedVulnerabilities = selected || [];
    },

    downloadFullReport() {
      console.log('Downloading full report for:', this.imageName);
      // Implementation for downloading full report
    },

    downloadCustomReport() {
      console.log('Downloading custom report with filters:', this.filters);
      // Implementation for downloading custom report
    },
  },
}
</script>

<style scoped>
.page {
  display: flex;
  flex-direction: column;
  padding: 20px;
  min-height: 100%;
  gap: 16px;
}

.header-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 16px;
}

.title {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 24px;
  font-weight: 600;
  color: #141419;
}

.severity-badge {
  font-size: 14px;
  font-weight: 500;
}

.critical-severity {
  background-color: #850917 !important;
  color: white !important;
}

.image-info-section {
  padding: 0;
}

.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px 32px;
}

.info-item {
  display: flex;
  justify-content: flex-start;
  gap: 16px;
  margin-bottom: 8px;
}

.label {
  color: #6C6C76;
  font-weight: 500;
  font-size: 14px;
}

.value {
  color: #141419;
  font-weight: 500;
  font-size: 14px;
}

.show-properties-link {
  margin-top: 0;
  padding-top: 0;
  justify-content: flex-start !important;
  grid-column: 3;
  grid-row: 4;
}

.show-properties-link a {
  color: #007cba;
  text-decoration: none;
  font-weight: 500;
  font-size: 14px;
}

.show-properties-link a:hover {
  text-decoration: underline;
}

.breadcrumbs {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  color: #6C6C76;
}

.breadcrumb-item {
  color: #007cba;
  cursor: pointer;
}

.breadcrumb-item:hover {
  text-decoration: underline;
}

.breadcrumb-separator {
  color: #6C6C76;
}

.image-info-section {
  padding: 0;
  margin-bottom: 24px;
}

.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px 32px;
}

.summary-section {
  display: flex;
  align-items: flex-start;
  align-self: stretch;
  border-radius: 6px;
  border: 1px solid #DCDEE7;
  background: #FFF;
  margin: 24px 0;
}

.vulnerabilities-section,
.severity-section {
  display: flex;
  padding: 16px;
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
  flex: 1;
  min-width: 0;
}

.vulnerabilities-section {
  border-right: 1px solid #DCDEE7;
}

.title {
  color: #141419;
  font-family: Lato;
  font-size: 18px;
  font-style: normal;
  font-weight: 600;
  line-height: 21px;
  margin-bottom: 8px;
}

.vulnerabilities-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  width: 100%;
}

.vulnerabilities-list .row {
  width: 100%;
  margin: 0;
}

.vulnerabilities-list .col {
  padding: 8px 16px;
  min-height: 32px;
}

.cve-id {
  font-weight: 700;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 14px;
}

.cve-link {
  color: #007cba;
  text-decoration: none;
  font-weight: 700;
}

.cve-link:hover {
  text-decoration: underline;
}

.score-badge {
  display: flex;
  align-items: center;
}

.score {
  color: #6C6C76;
  font-size: 13px;
  font-weight: 500;
  background: #E9ECEF;
  padding: 4px 8px;
  border-radius: 4px;
}

.package {
  color: #141419;
  font-weight: 500;
}

.fix-status {
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-filters {
  margin-bottom: 24px;
}

.filter-row {
  display: flex;
  gap: 24px;
  margin-bottom: 20px;
}

.filter-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex: 1;
}

.filter-item label {
  font-weight: 400;
  color: #6C6C76;
  font-size: 14px;
}

.filter-input-wrapper {
  display: flex;
  align-items: center;
  border: 1px solid #DCDEE7;
  border-radius: 6px;
  padding: 0 12px;
  background: #FFF;
}

.filter-input {
  flex: 1;
  padding: 10px 0;
  border: none;
  outline: none;
  font-size: 14px;
  background: transparent;
}

.score-input {
  color: #BEC1D2;
}

.score-input::placeholder {
  color: #BEC1D2;
}

.filter-input:focus {
  outline: none;
}

.filter-input-wrapper:focus-within {
  border-color: #007cba;
  box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.1);
}

.filter-select {
  padding: 10px 14px;
  border: 1px solid #DCDEE7;
  border-radius: 6px;
  font-size: 14px;
  background: #FFF;
  outline: none;
}

.filter-select:focus {
  border-color: #007cba;
  box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.1);
}

.filter-actions {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 8px;
  padding-top: 16px;
  border-top: 1px solid #DCDEE7;
}

.selected-count {
  font-weight: 500;
  color: #6C6C76;
}



.table-header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.table-top-left {
  display: flex;
  align-items: center;
  gap: 16px;
}
</style>
