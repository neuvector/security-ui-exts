<script>
  import { REGISTRY_SCAN_HISTORY_TABLE } from "@sbombastic-image-vulnerability-scanner/config/table-headers";
  import { RESOURCE } from "@sbombastic-image-vulnerability-scanner/types";
  import ResourceTable from "@shell/components/ResourceTable";

  export default {
    name: 'RegistryDetailScanTable',
    components: {
      ResourceTable
    },
    props: {
      registry: {
        type: Object,
        required: true
      }
    },
    data() {
      return {
        scanHistory: [],
        headers: REGISTRY_SCAN_HISTORY_TABLE
      }
    },
    async mounted() {
      await this.$store.dispatch('cluster/findAll', { type: RESOURCE.SCAN_JOB });

      if (this.registry) {
        let scanJobs = this.$store.getters['cluster/all'](RESOURCE.SCAN_JOB).filter((rec) => {
          return rec.spec.registry === this.registry.metadata.name;
        });

        this.scanHistory = scanJobs.map((rec) => {
          rec.status.statusResult = rec.status.conditions.filter(condition => {
            return condition.status === "True";
          })[0] || {
            type: "Pending",
            lastTransitionTime: null,
          };
          return rec;
        });
      }
    },
    watch: {
      async registry(newRegistry) {
        if (newRegistry) {
          let scanJobs = this.$store.getters['cluster/all'](RESOURCE.SCAN_JOB).filter((rec) => {
            return rec.spec.registry === newRegistry.metadata.name;
          });

          scanJobs.forEach((rec) => {
            this.scanHistory.push({
              ...rec,
              status: {
                ...rec.status,
                statusResult: rec.status.conditions.filter(condition => {
                  return condition.status === "True";
                })[0] || {
                  type: "Pending",
                  lastTransitionTime: null,
                }
              }
            })
          });
        }
      }
    }
  }
</script>

<template>
  <div class="registry-detail-scan-table">
    Recent scans
    <ResourceTable
      :headers="headers"
      :rows="scanHistory"
      :namespaced="false"
      :rowActions="false"
      :search="false"
    />
  </div>
</template>

<style lang="scss" scoped>
  .registry-detail-scan-table {
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 100%;
  }
</style>