<script>
import SortableTable from "@shell/components/SortableTable";
import LabeledSelect from "@shell/components/form/LabeledSelect";
import { BadgeState } from '@components/BadgeState';
import { Checkbox } from '@components/Form/Checkbox';
import {
  VULNERABILITIES_DETAIL_GROUP_BY_REPOSITORY_TABLE,
  VULNERABILITIES_DETAIL_IMAGE_LIST_TABLE, VULNERABILITIES_DETAIL_SUB_IMAGES_TABLE,
} from "@pkg/config/table-headers";
import { cveDetail, images } from "@pkg/data/sbombastic.rancher.io.cveDetails";

import { PRODUCT_NAME, RESOURCE, PAGE } from "@pkg/types";
import DownloadCustomReport from "@pkg/components/common/DownloadCustomReport.vue";

export default {
  name: 'CveDetails',
  components: {
    DownloadCustomReport,
    SortableTable,
    BadgeState,
    Checkbox,
    LabeledSelect,
  },
  data() {
    const imageFilterOptions = [
      this.t('imageScanner.images.filters.image.allImages'),
      this.t('imageScanner.images.filters.image.excludeBaseImages'),
      this.t('imageScanner.images.filters.image.includeBaseImages')
    ];
    return {
      PRODUCT_NAME,
      RESOURCE,
      PAGE,
      cveDetail: cveDetail,
      rows: images,
      images_table: VULNERABILITIES_DETAIL_IMAGE_LIST_TABLE,
      group_by_repository_table: VULNERABILITIES_DETAIL_GROUP_BY_REPOSITORY_TABLE,
      sub_images_table: VULNERABILITIES_DETAIL_SUB_IMAGES_TABLE,
      isGrouped: false,
      selected_images: [],
      selectedRows: [],
      preprocessedDataset: {},
      selectedImageFilter: imageFilterOptions[0],
      imageFilterOptions,
      hoverVendor: null,
      inside: false,
      showVendorPopup: false,
      selectedVendor: {},
    }
  },

  async fetch() {
    this.preprocessedDataset = this.preprocessData(this.rows);
    console.log("this.preprocessedDataset", this.preprocessedDataset);
  },

  methods: {
    updateData(event) {
      console.log("isGrouped", this.isGrouped);
    },
    onSelectionChange(selected) {
      console.log("selected", selected)
      this.selectedRows = selected || [];
    },
    preprocessData(images) {
      const repoMap = new Map();

      images.map(image => {
        let repoRec = {};
        const mapKey = `${image.repository},${image.registry}`;
        if(repoMap.has(mapKey)) {
          const currRepo = repoMap.get(mapKey);
          currRepo.images.push(image);
          repoMap.set(mapKey, currRepo);
        }else{
          repoRec = {
            id: mapKey,
            repository: image.repository,
            registry: image.registry,
            images: [image]
          }
          repoMap.set(mapKey, repoRec);
        }
      });

      return {
        rowsByRepo: Array.from(repoMap.values())
      };
    },
    showVendorPopup(vendor) {
      this.selectedVendor = vendor;
      this.showPopup = true;
    },

    getSeverityColor(severity) {
      console.log("getSeverityColor", severity);
      const colors = {
        critical: 'critical-severity',
        high: 'bg-error',
        medium: 'bg-warning',
        low: 'bg-warning',
        none: 'bg-info'
      };
      return colors[severity] || colors.none;
    },

  },
}
</script>
<template>
  <div class="page">
    <div class="about">
      <div class="header-section">
        <div class="title">
          <RouterLink :to="`/c/${this.$route.params.cluster}/${this.PRODUCT_NAME}/${this.PAGE.VULNERABILITY_OVERVIEW}`">{{ t('imageScanner.vulnerabilities.title') }}:</RouterLink>
        {{ $route.params.id }}
          <BadgeState
              :color="getSeverityColor(cveDetail.severity)"
              :label="t(`imageScanner.enum.cve.${cveDetail.severity}`)"
              class="severity-badge"
          />
        </div>
        <div class="filter-dropdown">
          <LabeledSelect
              v-model:value="selectedImageFilter"
              :options="imageFilterOptions"
              :close-on-select="true"
              :multiple="false"
          />
        </div>
        <div>
          <button class="btn role-primary">
            <i class="icon icon-download"></i>
            {{ t('imageScanner.images.downloadReport') }}
          </button>
        </div>

      </div>
  <!--    description -->
      <span class="description">{{ cveDetail.description }}</span>
  <!--  meta data  -->
      <div class="stats">
        <div class="column column-1">
          <div class="stats-item">
            <div class="stat-item">
              <span class="label">{{ t('imageScanner.vulnerabilities.details.score') }}:</span>
              <span class="value">{{ cveDetail.score }}</span>
            </div>
            <div class="stat-item">
              <span class="label">{{ t('imageScanner.vulnerabilities.details.affectedImages') }}:</span>
              <span class="value">{{ cveDetail.affectedImages }}</span>
            </div>
            <div class="stat-item">
              <span class="label">{{ t('imageScanner.vulnerabilities.details.imageIdentifiedIn') }}:</span>
              <span class="value">{{ cveDetail.totalImages }}</span>
            </div>
            <div class="stat-item">
              <span class="label">{{ t('imageScanner.vulnerabilities.details.published') }}:</span>
              <span class="value">{{ cveDetail.publishedDate }}</span>
            </div>
            <div class="stat-item">
              <span class="label">{{ t('imageScanner.vulnerabilities.details.lastModified') }}:</span>
              <span class="value">{{ cveDetail.lastModifiedDate }}</span>
            </div>
            <div class="stat-item">
              <span class="label">Sources</span>
              <span class="value">
                <a v-for="(source, index) in cveDetail.sources" :key="index" :href="source.link" target="_blank" class="source-link">
                  {{ source.name }}
                </a>
              </span>
            </div>
          </div>
        </div>
        <div class="column column-2">
          <div class="stat-item">
            <span class="label"> Advisory vendors </span>
            <span class="value">{{cveDetail.advisoryVendors.length}}</span>
          </div>
          <div class="vendor-tags-wrapper"
               @mouseenter="inside = true"
               @mouseleave="inside = false; hoverVendor = null"
          >
            <div class="vendor-tags">
               <span
                   v-for="(vendor, index) in cveDetail.advisoryVendors"
                   :key="index"
                   class="vendor-tag"
                   @mouseenter="hoverVendor = vendor"
               >
                {{ vendor.name }}
              </span>
            </div>

            <!-- Hover panel (always aligned with first tag) -->
            <div v-if="hoverVendor && inside" class="hover-panel">
              <h4>References for {{ cveDetail.id }}</h4>
              <div
                  v-for="(ref, rIndex) in hoverVendor.references"
                  :key="rIndex"
                  class="ref-item"
              >
                <a :href="ref.url" target="_blank" class="ref-url">{{ ref.url }}</a>
                <div class="ref-title">{{ ref.title }}</div>
              </div>
            </div>
          </div>
        </div>
        <div class="column column-3">
          <div class="stat-item">
            <span class="label">CVSS scores</span>
            <span class="value">{{cveDetail.cvssScores.length}}</span>
          </div>
          <div class="cvss-list">
            <a v-for="(score, index) in cveDetail.cvssScores" :key="index" :href="score.link" target="_blank" class="cvss-link">
              {{ score.source }} {{ score.score }}
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="table">
      <SortableTable
          :has-advanced-filtering="false"
          :namespaced="false"
          :row-actions="false"
          :table-actions="true"
          :force-update-live-and-delayed="0"
          :use-query-params-for-simple-filtering="true"
          :sub-expandable="isGrouped"
          :sub-rows="isGrouped"
          :sub-expand-column="isGrouped"
          :rows="isGrouped ? preprocessedDataset.rowsByRepo : rows"
          :headers="isGrouped ? group_by_repository_table : images_table"
          :key-field="'id'"
          @selection="onSelectionChange"
      >
        <template #header-left>
          <div class="table-top-left">
            <DownloadCustomReport
                class="table-btn"
                :selectedRows="selectedRows"
                :buttonName="t('imageScanner.images.buttons.downloadCustomReport')"
            />
          </div>
        </template>
        <template #header-right>
          <div class="table-top-right">
            <Checkbox
                style="margin-top: 8px; width: 180px;"
                label-key="imageScanner.images.listTable.checkbox.groupByRepo"
                v-model:value="isGrouped"
                @update:value="updateData($event)"
            />
          </div>
        </template>
        <template v-if="isGrouped" #sub-row="{ row, fullColspan }">
          <tr
              class="sub-row"
          >
            <td :colspan="fullColspan">
              <SortableTable
                  class="sub-table"
                  :rows="row.images"
                  :headers="sub_images_table"
                  :search="false"
                  :row-actions="false"
                  :table-actions="false"
              />
            </td>
          </tr>
        </template>
      </SortableTable>
    </div>
  </div>
</template>

<style lang="scss" scoped>
.btn {
  padding: 0 16px;
  gap: 12px;
}

.about {
  /* layout */
  display: flex;
  padding-bottom: 24px;
  flex-direction: column;
  align-items: flex-start;
  align-self: stretch;
  /* style */
  border-bottom: 1px dashed #DCDEE7;
}

.page {
  display: flex;
  padding: 24px;
  flex-direction: column;
  align-items: flex-start;
  gap: 24px;
  flex: 1 0 0;
  align-self: stretch;
}

.header-section {
  display: flex;
  align-items: flex-start;
  gap: 24px;
  align-self: stretch;

  .title {
    display: flex;
    align-items: flex-start;
    gap: 4px;
    flex: 1 0 0;
    color: #141419;
    font-family: Lato;
    font-size: 24px;
    font-style: normal;
    font-weight: 600;
  }

  .filter-dropdown {
    display: flex;
    width: 225px;
    height: 40px;
  }
}

.description {
  display: flex;
  max-width: 900px;
  height: 21px;
  flex-direction: column;
  justify-content: center;
  overflow: hidden;
  color: #717179;
  font-family: Lato;
  font-size: 14px;
  font-weight: 400;
  line-height: 21px;
}

.stats {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  align-items: flex-start;
  row-gap: 4px;
  column-gap: 24px;
  align-self: stretch;
  margin-top: 16px;
}

.stat-item {
  display: flex;
  align-items: flex-start;
  align-self: stretch;
  font-family: Lato;
  font-size: 14px;
  font-style: normal;
  font-weight: 400;
  line-height: 21px;
}
.label {
  display: flex;
  width: 144px;
  align-items: center;
  gap: 8px;
  color: #717179;
}
.value {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1 0 0;
  color: #141419;
}
.vendor-tags-wrapper {
  position: relative;
  display: inline-block;
  margin-top: 5px;
}
.vendor-tags {
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
}
.vendor-tag {
  margin-right: 5px;
  padding: 2px 6px;
  background-color: #e9ecef;
  border-radius: 4px;
  cursor: pointer;
}
.vendor-tag:hover {
  background-color: #d1d3e0;
}
.hover-panel {
  position: absolute;
  top: 20px;
  left: 0;
  background: white;
  border: 1px solid #ddd;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  border-radius: 8px;
  padding: 12px;

  min-width: 400px;
  max-width: 500px;
  width: auto;
  box-sizing: border-box;

  z-index: 1000;
}
.hover-panel h4 {
  margin: 0 0 6px;
  font-size: 14px;
}

.hover-panel a {
  color: #007acc;
  text-decoration: none;
}

.hover-panel a:hover {
  text-decoration: underline;
}

.ref-item {
  margin-bottom: 10px;
}

.ref-url {
  display: block;
  color: #0073e6;
  text-decoration: none;
  word-break: break-all;
}

.ref-title {
  font-size: 0.9rem;
  color: #444;
  margin-top: 2px;
}
.cvss-list {
  display: flex;
  flex-direction: column;
}
.cvss-link, .source-link {
  color: #007bff;
  text-decoration: none;
  margin-bottom: 5px;
}
.cvss-link:hover, .source-link:hover {
  text-decoration: underline;
}
.popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
}
.popup-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
}

.severity-badge {
  font-size: 14px;
  font-weight: 500;
}

.critical-severity {
  background-color: #850917 !important;
  color: white !important;
}

.table {
  width: 100%;
}

</style>