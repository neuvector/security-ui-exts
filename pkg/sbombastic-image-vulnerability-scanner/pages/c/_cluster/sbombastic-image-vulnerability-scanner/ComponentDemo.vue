<template>
  <div class="page">
    <h3 style="margin-bottom: 20px;">Display CR data in resource table </h3>
    <ResourceTable
      :schema="schema"
      :rows="rows"
      :namespaced="false"
      :headers="headers"
      :use-query-params-for-simple-filtering="true"
    />
    <hr style="margin: 20px 0;"/>
    <h3 style="margin-bottom: 20px;">CVE's amount bar by severity level </h3>
    <AmountBarBySeverity style="margin: 10px;" :cveAmount="topRiskyImages[0].cve_cnt" />
    <AmountBarBySeverity style="margin: 10px;" :cveAmount="topRiskyImages[0].cve_cnt" :isCollapsed="true"/>
    <AmountBarBySeverity style="margin: 10px;" :cveAmount="topRiskyImages[1].cve_cnt" />
    <AmountBarBySeverity style="margin: 10px;" :cveAmount="topRiskyImages[1].cve_cnt" :isCollapsed="true"/>
    <hr style="margin: 20px 0;"/>
    <h3 style="margin-bottom: 20px;">Most affected images at risk</h3>
    <TopRiskyImagesChart :topRiskyImages="topRiskyImages"/>
    <hr style="margin: 20px 0;"/>
    <h3 style="margin-bottom: 20px;">Block percentage bar for affacted images</h3>
    <p v-if="blockBarCnt > 1" style="color: red">Q1: Size observer is used in each bar to make it responsive. It is really resource consuming if there are 100+ in the table. Do we want to make the total blocks be calculated or just adjust the width of each block with a fixed block amount?</p>
    <p v-if="blockBarCnt > 1" style="color: red">Q2: On UX design, how may images represent one bar. It looks like a relative amount on the bar's presentation</p>
    <strong style="margin: 5px 0">{{ blockBarCnt }} block percentage bars are being rendered.</strong>
    <BlockPercentageBar v-for="n in blockBarCnt" style="margin: 4px 0" :eventHandler="resize" :percentage="Math.random() * 100"/>
    <h3 style="margin-bottom: 20px;">Block percentage bar for affacted images (not resizable)</h3>
    <BlockPercentageBarAlt style="margin: 4px 0" :percentage="Math.random() * 100" :ticks="200"/>
  </div>


</template>

<script>

  import { ref } from "vue";
  import { RESOURCE } from "@pkg/types";
  import ResourceTable from '@shell/components/ResourceTable';
  import AmountBarBySeverity from "@pkg/components/common/AmountBarBySeverity";
  import TopRiskyImagesChart from "@pkg/components/TopRiskyImagesChart";
  import BlockPercentageBar from "@pkg/components/common/BlockPercentageBar";
  import BlockPercentageBarAlt from "@pkg/components/common/BlockPercentageBarAlt.vue";

  export default {
    name: 'registries',
    components: {
      ResourceTable,
      AmountBarBySeverity,
      TopRiskyImagesChart,
      BlockPercentageBar,
      BlockPercentageBarAlt
    },
    data() {
      return {
        blockBarCnt: 1,
        topRiskyImages: [
          {
            image_name: "struts-attacher:1.0",
            cve_cnt: {
              critical: 128,
              high: 12,
              medium: 81,
              low: 256,
              none: 126,
            }
          },
          {
            image_name: "imagemagick4.8.5613",
            cve_cnt: {
              critical: 7,
              high: 0,
              medium: 1028,
              low: 24,
              none: 18,
            }
          },
          {
            image_name: "centos7.7.1908",
            cve_cnt: {
              critical: 72,
              high: 0,
              medium: 164,
              low: 0,
              none: 7,
            }
          },
          {
            image_name: "nginx1.19.10",
            cve_cnt: {
              critical: 150,
              high: 5,
              medium: 850,
              low: 600,
              none: 73,
            }
          },
          {
            image_name: "docker-compose:1.29.2",
            cve_cnt: {
              critical: 35,
              high: 2,
              medium: 450,
              low: 120,
              none: 9,
            }
          },
        ],
        content: ref("Registries"),
        headers: [
          {
            name:          'name',
            label:         'Name',
            value:         'id',
            sort:          ['nameSort'],
            canBeVariable: true,
          },
          {
            name:          'registries',
            label:         'Registries',
            value:         'spec.repositories',
            sort:          ['nameSort'],
            canBeVariable: true,
          },
          {
            name:          'uri',
            label:         'URI',
            value:         'spec.uri',
            sort:          ['nameSort'],
            canBeVariable: true,
          },
        ],
      }
    },

    async fetch() {
      await this.$store.dispatch('cluster/findAll', { type: RESOURCE.REGISTRY });
    },
    beforeDestroy() {
        window.removeEventListener('resize', this.debounce);
    },
    methods: {
      resize(fn) {
        window.addEventListener('resize', this.debounce(fn), 500);
      },
      debounce(func, delay = 300) {
        let timeout
        return function (...args) {
            clearTimeout(timeout)
            timeout = setTimeout(() => func.apply(this, args), delay)
        }
      }
    },
    computed: {
      rows() {
        return this.$store.getters['cluster/all'](RESOURCE.REGISTRY);
      },
      schema() {
        return this.$store.getters['cluster/schemaFor'](RESOURCE.REGISTRY);
      }
    }
  }

</script>


<style scoped>
  .page {
    display: flex;
    flex-direction: column;
    padding: 20px;
    min-height: 100%;
  }

</style>