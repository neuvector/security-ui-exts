<template>
  <div class="page">
    <div class="header-section">
      <div class="header-left">
        <div class="title-wrap">
          <div class="title">{{ t('imageScanner.registries.title') }}</div>
        </div>
        <div class="state">&lt;State as of <span class="state-date-time">Jan 27, 2025  11:07 PM</span>&gt;</div>
      </div>
      <div class="header-right">
        <div class="header-btn">
          <button
            mat-button
            class="btn role-secondary"
            aria-label="Refresh data"
            type="button"
            :disabled="disabled"
            @click="refresh()">
            <em class="icon-refresh-ss"></em>{{ t('imageScanner.registries.button.refresh') }}
          </button>
        </div>
        <div class="header-btn">
          <button
            mat-button
            class="btn role-primary"
            aria-label="Add new"
            type="button"
            :disabled="disabled"
            @click="openAddEditRegistry()">
            <em class="icon-add"></em>{{ t('imageScanner.registries.button.addNew') }}
          </button>
        </div>
      </div>
    </div>
    <div class="summary-section">
      <RecentUpdatedRegistries :registryStatusList="registryStatusList"/>
      <StatusDistribution :chartData="statusSummary"/>
    </div>
    <ResourceTable
      :schema="schema"
      :rows="rows"
      :namespaced="false"
      :headers="headers"
      :use-query-params-for-simple-filtering="true"
    />
    <p v-for="row of rows">
      <RouterLink :to="`/c/${this.$route.params.cluster}/${ this.PRODUCT_NAME }/registries/${ row.id }`">
        {{ row.id }}
      </RouterLink>
    </p>
  </div>
</template>

<script>

  import { ref } from "vue";
  import { RESOURCE } from "@sbombastic-image-vulnerability-scanner/types";
  import ResourceTable from "@shell/components/ResourceTable";
  import RecentUpdatedRegistries from "@sbombastic-image-vulnerability-scanner/components/RecentUpdatedRegistries";
  import StatusDistribution from "@sbombastic-image-vulnerability-scanner/components/StatusDistribution";
  import { REGISTRY_SCAN_TABLE } from "@sbombastic-image-vulnerability-scanner/config/table-headers";
  import {
    PRODUCT_NAME,
  } from "@sbombastic-image-vulnerability-scanner/types";

  export default {
    name: 'registries',
    components: {
      ResourceTable,
      RecentUpdatedRegistries,
      StatusDistribution
    },
    data() {
      return {
        content: ref("Registries"),
        PRODUCT_NAME: PRODUCT_NAME,
        registryStatusList: [
          {
            scan_name: "prod repo",
            registry_name: "https://registry.hub.com",
            prev_status: "in_progress",
            curr_status: "completed",
            last_update_time: 1752491022
          },
           {
            scan_name: "cfl-ctf",
            registry_name: "https://registry.docker.com",
            prev_status: "pending",
            curr_status: "in_progress",
            last_update_time: 1752735822
          },
           {
            scan_name: "fed.kubewarden",
            registry_name: "https://registry.hub.docker.com",
            prev_status: "in_progress",
            curr_status: "failed",
            last_update_time: 1752840334
          },
           {
            scan_name: "fed.onlinebutique",
            registry_name: "https://registry.hub.com",
            prev_status: "in_progress",
            curr_status: "scheduled",
            last_update_time: 1750262909
          },
           {
            scan_name: "sys reg",
            registry_name: "https://reg.docker..com",
            prev_status: "scheduled",
            curr_status: "in_progress",
            last_update_time: 1745525244
          },
        ],
        statusSummary: {
          pending: 39,
          scheduled: 8,
          in_progress: 46,
          completed: 187,
          failed: 35
        },
        headers: REGISTRY_SCAN_TABLE,
      }
    },

    async fetch() {
      await this.$store.dispatch('cluster/findAll', { type: RESOURCE.REGISTRY });
      if (this.$store.getters['cluster/canList'](RESOURCE.SCAN_JOB)) {
        this.$store.dispatch('cluster/findAll', { type: RESOURCE.SCAN_JOB });
      }
    },
    methods: {
      refresh() {},
      openAddEditRegistry() {}
    },
    computed: {
      rows() {
        let registriesCRD = this.$store.getters['cluster/all'](RESOURCE.REGISTRY);
        //Make mock data for UI test
        registriesCRD = registriesCRD.map((rec, index) => {
          if (index === 0) {
            rec.schedule = 3;
            rec._status = "failed";
            rec.errors = [
              {
                message: "Not enough resources to complete the scan. Could not connect to proxyu",
              },
            ];
            rec.progress = 35;
            rec.previous = {
              _status: "scheduled",
              errors: [],
              progress: 0
            };
          } else {
            rec.schedule = 29;
            rec._status = "completed";
            rec.errors = [];
            rec.progress = 100;
            rec.previous = {
              _status: "Failed",
              errors: [
                {
                  message: "Not enough resources to complete the scan. Could not connect to proxyu",
                },
              ],
              progress: 49
            };
          }
          return rec;
        });
        return registriesCRD;
      },
      schema() {
        return this.$store.getters['cluster/schemaFor'](RESOURCE.REGISTRY);
      }
    }
  }

</script>


<style lang="scss" scoped>
  .page {
    display: flex;
    flex-direction: column;
    padding: 20px;
    min-height: 100%;
  }
  .header-section {
    display: flex;
    align-items: flex-start;
    gap: 24px;
    align-self: stretch;
    margin-bottom: 24px;
    .header-left {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      gap: 4px;
      flex: 1 0 0;
    }
    .title-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      align-self: stretch;
      .title {
        color: #141419;
        font-family: Lato;
        font-size: 24px;
        font-style: normal;
        font-weight: 600;
        line-height: 32px; /* 133.333% */
      }
      .state {
        display: -webkit-box;
        max-width: 900px;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 1;
        align-self: stretch;
        overflow: hidden;
        color: #717179;

        text-overflow: ellipsis;
        font-family: Lato;
        font-size: 14px;
        font-style: normal;
        font-weight: 400;
        line-height: 21px; /* 150% */

        .state-date-time {
          overflow: hidden;
          -webkit-box-orient: vertical;
          -webkit-line-clamp: 1;
          color: #717179;
          text-overflow: ellipsis;
          font-family: Lato;
          font-size: 14px;
          font-style: normal;
          font-weight: 600;
          line-height: 21px;
        }
      }
    }
    .header-right {
      display: flex;
      align-items: flex-end;
      justify-content: end;
      flex: 1 0 0;
      gap: 24px;
    }
    .header-btn {
      height: 40px;
    }
    .icon-add {
      width: 16px;
      height: 16px;
      margin-right: 12px;
      background: url('../../../../assets/img/add.svg') no-repeat center center;
      background-size: contain;
    }
    .icon-refresh-ss {
      width: 16px;
      height: 16px;
      margin-right: 12px;
      background: url('../../../../assets/img/refresh.svg') no-repeat center center;
      background-size: contain;
    }
  }
  .summary-section {
    display: flex;
    min-width: 912px;
    align-items: flex-start;
    align-self: stretch;
    border-radius: 6px;
    border: 1px solid #DCDEE7;
    background: #FFF;
    margin: 24px 0;
  }
   
</style>