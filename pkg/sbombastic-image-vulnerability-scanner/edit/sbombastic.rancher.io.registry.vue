<script>
import CreateEditView from '@shell/mixins/create-edit-view';
import Footer from '@shell/components/form/Footer';
import { LabeledInput } from '@components/Form/LabeledInput';
import NameNsDescription from '@shell/components/form/NameNsDescription';
import CruResource from '@shell/components/CruResource';
import SelectOrCreateAuthSecret from '@shell/components/form/SelectOrCreateAuthSecret';
import LabeledSelect from '@shell/components/form/LabeledSelect';
import { Checkbox } from '@components/Form/Checkbox';
import { MANAGEMENT, NAMESPACE } from '@shell/config/types';
import {
  REGISTRY_TYPE_OPTIONS,
  SCAN_INTERVAL_OPTIONS, SCAN_INTERVALS
} from "@sbombastic-image-vulnerability-scanner/constants/scan-interval-options";
import { PRODUCT_NAME, PAGE } from "@sbombastic-image-vulnerability-scanner/types";

export default {
  name: 'CruRegistry',

  components: {
    Footer,
    LabeledInput,
    NameNsDescription,
    CruResource,
    SelectOrCreateAuthSecret,
    Checkbox,
    LabeledSelect
  },

  mixins: [CreateEditView],

  data() {
    if (!this.value.spec) {
      this.value.spec = {
        authSecret: '',
        uri: '',
        repositories: [],
      };
    }
    if (!this.value.status){
      this.value.status = {
        conditions: [],
      };
    }

    return {
      inStore: this.$store.getters['currentProduct'].inStore,
      errors: null,
      PAGE,
      PRODUCT_NAME,
    };
  },

  computed: {
    inStore() {
      return this.$store.getters['currentProduct']?.inStore || MANAGEMENT;
    },
    secretNamespace() {
      const currentNamespace = this.value.metadata?.namespace? this.value.metadata.namespace: this.$store.getters['defaultNamespace'];
      const tryNames = [ currentNamespace, 'default'];

      for ( const name of tryNames ) {
        if ( this.$store.getters['cluster/byId'](NAMESPACE, name) ) {
          return name;
        }
      }

      return this.$store.getters[`${ this.inStore }/all`](NAMESPACE)[0]?.id;
    },

    SCAN_INTERVAL_OPTIONS: function() {
      return SCAN_INTERVAL_OPTIONS;
    },

    REGISTRY_TYPE_OPTIONS: function() {
      return REGISTRY_TYPE_OPTIONS;
    },
    doneLocationOverride() {
      return `/c/${this.$route.params.cluster}/${ this.PRODUCT_NAME }/${this.PAGE.REGISTRIES}`;
    },
  },

  methods: {
    apply(event) {
      console.log('finish apply');
      this.save(event)
        .then(() => {
          this.$emit('done');
        })
        .catch((e) => {
          this.errors = e;
        })
        .finally(() => {
          this.$router.push({
            name: `c-cluster-${PRODUCT_NAME}-${PAGE.REGISTRIES}`,
            params: {
              cluster: this.$route.params.cluster,
              product: PRODUCT_NAME
            }
          });
        });
    },

    doneRoute() {
      console.log('doneRoute');
      return `c-cluster-${PRODUCT_NAME}-${PAGE.REGISTRIES}`;
    },
  },

  // Set default values for creating a new registry configuration
  created() {
    const spec = this.value.spec;

    spec.scanInterval ??= SCAN_INTERVALS.THREE_HOURS;
  }
}
</script>

<template>
  <div class="filled-height">
    <CruResource
        :done-route="doneRoute"
        :mode="mode"
        :resource="value"
        :description="t('imageScanner.registries.configuration.cru.description')"
        :subtypes="[]"
        :validation-passed="true"
        :errors="errors"
        :cancel-event="true"
        @error="(e) => (errors = e)"
        @finish="apply"
        @cancel="done"
    >
      <NameNsDescription
          nameLabel="imageScanner.registries.configuration.cru.registry.label"
          :value="value"
          :mode="mode"
          @update:value="$emit('input', $event)"
      />

      <div class="registry-input-label">
        {{ t('imageScanner.registries.configuration.cru.registry.label') }}
      </div>

      <div class="row">
        <div class="col span-6" >
          <LabeledSelect
              data-testid="registry-type-select"
              :label="t('imageScanner.registries.configuration.cru.registry.type.label')"
              :options="REGISTRY_TYPE_OPTIONS"
              option-key="value"
              option-label="label"
              value="dockerhub"
              required
          />
        </div>
        <div class="col span-6">
          <LabeledInput
              :label="t('imageScanner.registries.configuration.cru.registry.uri.label')"
              v-model:value="value.spec.uri"
              :placeholder="t('imageScanner.registries.configuration.cru.registry.uri.placeholder')"
              required
          />
        </div>
      </div>
      <div class="registry-input-label mt-24 mb-0">
        {{ t('imageScanner.registries.configuration.cru.authentication.label') }}
      </div>
      <SelectOrCreateAuthSecret
          v-model:value="value.spec.authSecret"
          :mode="mode"
          data-testid="registry-auth-secret"
          :register-before-hook="registerBeforeHook"
          :namespace="secretNamespace"
          :limit-to-namespace="true"
          :in-store="inStore"
          :allow-ssh=false
          generate-name="registry-auth-"
          :cache-secrets="true"
      />
      <div class="registry-input-label mt-24">
        {{ t('imageScanner.registries.configuration.cru.scan.label') }}
      </div>

      <div class="row">
        <div class="col span-6" >
          <LabeledSelect
              data-testid="registry-scanning-repository-names"
              v-model:value="value.spec.repositories"
              :taggable="true"
              :searchable="true"
              :push-tags="true"
              :close-on-select="false"
              :mode="mode"
              :multiple="true"
              :label="t('imageScanner.registries.configuration.cru.scan.repoName')"
              :placeholder="t('imageScanner.registries.configuration.cru.scan.placeholder')"
              :options="value.spec.repositories || []"
              :disabled="mode==='view'"
              @update:value="update"
          />
        </div>
        <div class="col span-3">
          <LabeledSelect
              v-model:value="value.spec.scanInterval"
              data-testid="registry-scanning-interval-select"
              :options = "SCAN_INTERVAL_OPTIONS"
              option-key="value"
              option-label="label"
              :label="t('imageScanner.registries.configuration.cru.scan.schedule.label')"
              required
          />
        </div>
      </div>

    </CruResource>
  </div>
</template>

<style lang="scss" scoped>
.registry-input-label {
  margin-bottom: 16px;
  font-size: 16px;
  line-height: 20px;
  font-weight: 500;
  font-family: 'Lato', sans-serif;
  color: #141419;
  display: block;
}
.mt-24 {
  margin-top: 24px;
}
</style>