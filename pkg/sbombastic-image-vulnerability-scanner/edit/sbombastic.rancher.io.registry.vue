<script>
import CreateEditView from '@shell/mixins/create-edit-view';
import Footer from '@shell/components/form/Footer';
import { LabeledInput } from '@components/Form/LabeledInput';
import { RadioGroup } from '@components/Form/Radio';
import NameNsDescription from '@shell/components/form/NameNsDescription';
import CruResource from '@shell/components/CruResource';
import SelectOrCreateAuthSecret from '@shell/components/form/SelectOrCreateAuthSecret';
import LabeledSelect from '@shell/components/form/LabeledSelect';
import Banner from '@components/Banner/Banner.vue';
import { Checkbox } from '@components/Form/Checkbox';
import { MANAGEMENT, NAMESPACE } from '@shell/config/types';
import UnitInput from '@shell/components/form/UnitInput.vue';
import {
  REGISTRY_TYPE_OPTIONS,
  SCAN_INTERVAL_OPTIONS
} from "@sbombastic-image-vulnerability-scanner/constants/scan-interval-options";

export default {
  name: 'CruRegistry',

  components: {
    Footer,
    RadioGroup,
    LabeledInput,
    NameNsDescription,
    CruResource,
    SelectOrCreateAuthSecret,
    Banner,
    Checkbox,
    UnitInput,
    LabeledSelect
  },

  mixins: [CreateEditView],

  data() {
    if (!this.value.spec) {
      this.value.spec = {
        insecure: true,
        authSecret: '',
        caBundle: '',
        type: {},
        uri: '',
        repositories: [],
      };
    }
    if (!this.value.status){
      this.value.status = {
        conditions: [],
      };
    }

    return {
      selectedRegistryType: this.value.type || 'ecr',
      secretNamespace: this.$store.getters['defaultNamespace'],
      inStore: this.$store.getters['currentProduct'].inStore,
      errors: null,
    };
  },

  computed: {
    namespace(){
      console.log('this.value.spec.type:',this.value.spec.type);
      return this.value.spec.type === 'ecr'?"kube-system":""
    },

    inStore() {
      return this.$store.getters['currentProduct']?.inStore || MANAGEMENT;
    },
    secretNamespace() {
      const tryNames = ['cattle-system', 'default'];

      for ( const name of tryNames ) {
        if ( this.$store.getters['cluster/byId'](NAMESPACE, name) ) {
          return name;
        }
      }

      return this.$store.getters[`${ this.inStore }/all`](NAMESPACE)[0]?.id;
    },

    SCAN_INTERVAL_OPTIONS: function() {
      return SCAN_INTERVAL_OPTIONS;
    },

    REGISTRY_TYPE_OPTIONS: function() {
      return REGISTRY_TYPE_OPTIONS;
    },

    useProxy: {
      get() {
        return !this.value.spec.insecure;
      },
      set(val) {
        this.value.spec.insecure = !val;
      }
    }
  },
}

</script>
<template>
  <div class="filled-height">
    <Banner color="info">
      {{t('imageScanner.registries.configuration.cru.description')}}
    </Banner>
    <CruResource
        :done-route="doneRoute"
        :mode="mode"
        :resource="value"
        :subtypes="[]"
        :validation-passed="true"
        :errors="errors"
        @error="(e) => (errors = e)"
        @finish="save"
        @cancel="done"
    >
      <NameNsDescription
          :value="value"
          :mode="mode"
          @update:value="$emit('input', $event)"
      />

      <div class="registry-input-label">
        {{ t('imageScanner.registries.configuration.cru.registry.label') }}
      </div>

      <div class="row">
        <div class="col span-6" >
          <LabeledSelect
              data-testid="registry-type-select"
              :label="t('imageScanner.registries.configuration.cru.registry.type.label')"
              :options="REGISTRY_TYPE_OPTIONS"
              option-key="value"
              option-label="label"
              value="dockerhub"
              required
          />
        </div>
        <div class="col span-6">
          <LabeledInput
              :label="t('imageScanner.registries.configuration.cru.registry.uri.label')"
              v-model:value="value.spec.uri"
              :placeholderKey="t('imageScanner.registries.configuration.cru.registry.uri.placeholder')"
          />
        </div>
      </div>

      <Checkbox
          v-model:value="useProxy"
          class="mt-20 mb-10"
          :mode="mode"
          :label="t('imageScanner.registries.configuration.cru.proxy.enable')"
          :tooltipKey="t('imageScanner.registries.configuration.cru.proxy.tooltip')"
          data-testid="registry-use-proxy"
      />

      <div v-if="useProxy">
        <div class="registry-input-label mb-0">
          {{ t('imageScanner.registries.configuration.cru.authLabel') }}
        </div>
        <SelectOrCreateAuthSecret
            :value="value.spec.authSecret"
            :mode="mode"
            data-testid="registry-auth-secret"
            :register-before-hook="registerBeforeHook"
            :namespace="secretNamespace"
            :limit-to-namespace="true"
            :in-store="inStore"
            :allow-ssh=false
            generate-name="registry-auth-"
            :cache-secrets="true"
            @input="val => value.spec.authSecret = val"
        />

        <div class="registry-input-label mt-24">
          {{ t('imageScanner.registries.configuration.cru.scan.label') }}
        </div>

        <div class="row">
          <div class="col span-6" >
            <LabeledSelect
                v-model:value="value.spec.repositories"
                :label="t('imageScanner.registries.configuration.cru.scan.type')"
            >
            </LabeledSelect>
          </div>
          <div class="col span-3">
            <LabeledSelect
                v-model:value="value.spec.scanInterval"
                data-testid="registry-scan-interval-select"
                :options = "SCAN_INTERVAL_OPTIONS"
                option-key="value"
                option-label="label"
                value="0s"
                :label="t('imageScanner.registries.configuration.cru.scan.schedule.label')"
            />
          </div>
        </div>

      </div>

    </CruResource>
  </div>
</template>

<style lang="scss" scoped>
.registry-input-label {
  margin-bottom: 16px;
  font-size: 16px;
  line-height: 20px;
  font-weight: 500;
  font-family: 'Lato', sans-serif;
  color: #141419;
  display: block;
}
.mt-24 {
  margin-top: 24px;
}
</style>